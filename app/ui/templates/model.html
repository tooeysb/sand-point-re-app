{% extends "base.html" %}

{% block title %}Model Editor - RE Financial Model{% endblock %}

{% block head %}
<style>
    /* Premium Fintech Theme */
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --accent-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --dark-gradient: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        --card-shadow: 0 10px 40px -10px rgba(0,0,0,0.15);
        --input-shadow: 0 2px 8px rgba(102, 126, 234, 0.15);
        --glow-primary: 0 0 20px rgba(102, 126, 234, 0.4);
    }

    /* Tooltip Styles */
    .tooltip-trigger {
        position: relative;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .tooltip-icon {
        width: 16px;
        height: 16px;
        background: linear-gradient(135deg, #94a3b8 0%, #64748b 100%);
        border-radius: 50%;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: help;
        transition: all 0.2s ease;
        flex-shrink: 0;
    }

    .tooltip-icon:hover {
        background: var(--primary-gradient);
        transform: scale(1.1);
    }

    .tooltip-icon svg {
        width: 10px;
        height: 10px;
        color: white;
    }

    .tooltip-content {
        position: absolute;
        bottom: calc(100% + 10px);
        left: 50%;
        transform: translateX(-50%);
        width: 280px;
        padding: 14px 16px;
        background: linear-gradient(145deg, #1e293b 0%, #0f172a 100%);
        color: white;
        border-radius: 12px;
        font-size: 13px;
        font-weight: 400;
        line-height: 1.5;
        text-transform: none;
        letter-spacing: normal;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        opacity: 0;
        visibility: hidden;
        transition: all 0.2s ease;
        z-index: 1000;
        pointer-events: none;
    }

    .tooltip-content::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 8px solid transparent;
        border-top-color: #0f172a;
    }

    .tooltip-trigger:hover .tooltip-content {
        opacity: 1;
        visibility: visible;
        pointer-events: auto;
    }

    .tooltip-content strong {
        color: #60a5fa;
        font-weight: 600;
    }

    .tooltip-content em {
        color: #fbbf24;
        font-style: normal;
    }

    /* Calculated field tooltip - different style */
    .tooltip-calculated .tooltip-content {
        background: linear-gradient(145deg, #1e3a5f 0%, #0c1929 100%);
        border-left: 3px solid #3b82f6;
    }

    .metric-tooltip {
        position: relative;
        cursor: help;
    }

    .metric-tooltip .tooltip-content {
        bottom: auto;
        top: calc(100% + 10px);
        width: 260px;
    }

    .metric-tooltip .tooltip-content::after {
        top: auto;
        bottom: 100%;
        border-top-color: transparent;
        border-bottom-color: #0f172a;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        box-shadow: var(--card-shadow);
    }

    .metric-card {
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        border: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
    }

    .metric-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 30px rgba(0,0,0,0.12);
    }

    .input-premium {
        background: linear-gradient(145deg, #ffffff 0%, #f8fafc 100%);
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        padding: 14px 16px;
        font-size: 16px;
        font-weight: 500;
        transition: all 0.3s ease;
        box-shadow: var(--input-shadow);
    }

    .input-premium:focus {
        border-color: #667eea;
        box-shadow: var(--glow-primary);
        outline: none;
    }

    .input-premium:hover:not(:focus) {
        border-color: #cbd5e1;
    }

    .input-label {
        display: block;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748b;
        margin-bottom: 8px;
    }

    .input-group {
        position: relative;
    }

    .input-prefix {
        position: absolute;
        left: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-weight: 600;
        font-size: 16px;
    }

    .input-suffix {
        position: absolute;
        right: 16px;
        top: 50%;
        transform: translateY(-50%);
        color: #94a3b8;
        font-weight: 600;
        font-size: 14px;
    }

    .input-premium.has-prefix {
        padding-left: 36px;
    }

    .input-premium.has-suffix {
        padding-right: 50px;
    }

    .section-card {
        background: white;
        border-radius: 20px;
        padding: 28px;
        box-shadow: 0 4px 24px rgba(0,0,0,0.06);
        border: 1px solid rgba(0,0,0,0.04);
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 24px;
        padding-bottom: 16px;
        border-bottom: 2px solid #f1f5f9;
    }

    .section-icon {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 20px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 700;
        color: #1e293b;
    }

    .tab-premium {
        padding: 16px 24px;
        font-weight: 600;
        font-size: 14px;
        border-radius: 12px 12px 0 0;
        transition: all 0.3s ease;
        border: none;
        background: transparent;
        color: #64748b;
        position: relative;
    }

    .tab-premium:hover {
        color: #667eea;
        background: rgba(102, 126, 234, 0.05);
    }

    .tab-premium.active {
        color: #667eea;
        background: white;
        box-shadow: 0 -4px 20px rgba(102, 126, 234, 0.15);
    }

    .tab-premium.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: var(--primary-gradient);
        border-radius: 3px 3px 0 0;
    }

    .btn-primary-gradient {
        background: var(--primary-gradient);
        color: white;
        font-weight: 600;
        padding: 12px 28px;
        border-radius: 12px;
        border: none;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .btn-primary-gradient:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
    }

    .btn-secondary-gradient {
        background: linear-gradient(145deg, #f8fafc 0%, #e2e8f0 100%);
        color: #475569;
        font-weight: 600;
        padding: 12px 28px;
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .btn-secondary-gradient:hover {
        background: linear-gradient(145deg, #ffffff 0%, #f1f5f9 100%);
        border-color: #cbd5e1;
    }

    .hero-metric {
        text-align: center;
        padding: 20px;
        border-radius: 16px;
        position: relative;
        overflow: hidden;
    }

    .hero-metric::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        border-radius: 4px 4px 0 0;
    }

    .hero-metric.primary::before {
        background: var(--primary-gradient);
    }

    .hero-metric.success::before {
        background: var(--success-gradient);
    }

    .hero-metric.accent::before {
        background: var(--accent-gradient);
    }

    .hero-metric-value {
        font-size: 32px;
        font-weight: 800;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .hero-metric.success .hero-metric-value {
        background: var(--success-gradient);
        -webkit-background-clip: text;
        background-clip: text;
    }

    .hero-metric.accent .hero-metric-value {
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        background-clip: text;
    }

    .data-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
    }

    .data-table thead th {
        background: linear-gradient(145deg, #f8fafc 0%, #f1f5f9 100%);
        padding: 14px 16px;
        font-size: 11px;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748b;
        text-align: left;
        border-bottom: 2px solid #e2e8f0;
    }

    .data-table tbody td {
        padding: 16px;
        border-bottom: 1px solid #f1f5f9;
        font-size: 14px;
    }

    .data-table tbody tr:hover {
        background: rgba(102, 126, 234, 0.03);
    }

    .badge {
        display: inline-flex;
        align-items: center;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .badge-success {
        background: rgba(16, 185, 129, 0.1);
        color: #059669;
    }

    .badge-warning {
        background: rgba(245, 158, 11, 0.1);
        color: #d97706;
    }

    .loading-overlay {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(8px);
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid #e2e8f0;
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .pulse-dot {
        width: 8px;
        height: 8px;
        background: #10b981;
        border-radius: 50%;
        animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.5; transform: scale(1.2); }
    }
</style>
{% endblock %}

{% block content %}
<div x-data="modelEditor()" x-init="init()" class="min-h-screen bg-gradient-to-br from-slate-50 via-white to-slate-100">

    <!-- Notifications -->
    <div class="fixed top-4 right-4 z-50 space-y-2">
        <div x-show="error" x-transition:enter="transition ease-out duration-300"
             x-transition:enter-start="opacity-0 transform translate-x-8"
             x-transition:enter-end="opacity-100 transform translate-x-0"
             class="bg-red-50 border-l-4 border-red-500 p-4 rounded-r-xl shadow-lg max-w-md">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-red-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <span class="text-red-800 font-medium" x-text="error"></span>
                <button @click="error = null" class="ml-auto text-red-400 hover:text-red-600">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                </button>
            </div>
        </div>
        <div x-show="successMessage" x-transition class="bg-emerald-50 border-l-4 border-emerald-500 p-4 rounded-r-xl shadow-lg max-w-md">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-emerald-500 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                <span class="text-emerald-800 font-medium" x-text="successMessage"></span>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div x-show="loading" class="fixed inset-0 loading-overlay flex items-center justify-center z-50">
        <div class="text-center">
            <div class="spinner mx-auto mb-4"></div>
            <p class="text-slate-600 font-medium">Processing your model...</p>
        </div>
    </div>

    <!-- Property Creation Modal -->
    <div x-show="showPropertyModal" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm flex items-center justify-center z-50">
        <div class="bg-white rounded-3xl shadow-2xl max-w-lg w-full mx-4 p-8 transform transition-all">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                </div>
                <h3 class="text-2xl font-bold text-slate-900">Create New Property</h3>
                <p class="text-slate-500 mt-2">Set up your property to start modeling</p>
            </div>

            <div class="space-y-5">
                <div>
                    <label class="input-label">Property Name</label>
                    <input type="text" x-model="newProperty.name" class="input-premium w-full" placeholder="e.g., 225 Worth Ave">
                </div>
                <div>
                    <label class="input-label">Property Type</label>
                    <select x-model="newProperty.property_type" class="input-premium w-full">
                        <option value="retail">Retail</option>
                        <option value="office">Office</option>
                        <option value="multifamily">Multifamily</option>
                        <option value="industrial">Industrial</option>
                        <option value="mixed">Mixed Use</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="input-label">City</label>
                        <input type="text" x-model="newProperty.address_city" class="input-premium w-full" placeholder="Palm Beach">
                    </div>
                    <div>
                        <label class="input-label">State</label>
                        <input type="text" x-model="newProperty.address_state" class="input-premium w-full" maxlength="2" placeholder="FL">
                    </div>
                </div>
                <div>
                    <label class="input-label">Net Rentable SF</label>
                    <div class="input-group">
                        <input type="number" x-model.number="newProperty.net_rentable_sf" class="input-premium w-full has-suffix">
                        <span class="input-suffix">SF</span>
                    </div>
                </div>
            </div>

            <div class="mt-8 flex gap-4">
                <button @click="showPropertyModal = false; window.location.href = '/'" class="btn-secondary-gradient flex-1">
                    Cancel
                </button>
                <button @click="createProperty()" :disabled="!newProperty.name" class="btn-primary-gradient flex-1 disabled:opacity-50">
                    Create Property
                </button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-6 py-8">

        <!-- Header -->
        <div class="flex flex-wrap items-center justify-between gap-4 mb-8">
            <div>
                <div class="flex items-center gap-3 mb-2">
                    <div class="pulse-dot"></div>
                    <span class="text-sm font-medium text-emerald-600">Live Model</span>
                </div>
                <h1 class="text-3xl font-bold text-slate-900" x-text="scenario.name || 'Financial Model'"></h1>
                <p class="text-slate-500 mt-1">
                    <span x-text="property.name"></span>
                    <span x-show="property.address_city" class="text-slate-400"> Â· </span>
                    <span x-show="property.address_city" x-text="property.address_city + ', ' + property.address_state"></span>
                </p>
            </div>
            <div class="flex gap-3">
                <button @click="showAnalysisModal = true" class="flex items-center gap-2 px-4 py-2 rounded-xl font-medium transition-all"
                        :class="dealAnalysis.hasCriticalIssues ? 'bg-red-100 text-red-700 hover:bg-red-200' : dealAnalysis.hasIssues ? 'bg-amber-100 text-amber-700 hover:bg-amber-200' : 'bg-emerald-100 text-emerald-700 hover:bg-emerald-200'">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                    <span x-text="dealAnalysis.hasCriticalIssues ? 'Issues Found' : dealAnalysis.hasIssues ? 'Warnings' : 'Analyze Deal'"></span>
                </button>
                <button @click="calculateModel()" :disabled="loading" class="btn-secondary-gradient flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                    </svg>
                    Calculate
                </button>
                <button @click="saveScenario()" :disabled="loading" class="btn-primary-gradient flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                    </svg>
                    Save Model
                </button>
            </div>
        </div>

        <!-- Calculation Error Banner -->
        <div x-show="metrics._errors && metrics._errors.length > 0" class="mb-4 bg-red-50 border border-red-200 rounded-xl p-4">
            <div class="flex items-start gap-3">
                <svg class="w-5 h-5 text-red-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                <div>
                    <p class="font-semibold text-red-800">Calculation Errors</p>
                    <ul class="mt-1 text-sm text-red-700 list-disc list-inside">
                        <template x-for="err in (metrics._errors || [])" :key="err">
                            <li x-text="err"></li>
                        </template>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Return Metrics Dashboard -->
        <div x-show="metrics.unleveraged_irr || metrics.leveraged_irr" class="mb-8">
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4">
                <div class="metric-card rounded-2xl p-5 hero-metric primary metric-tooltip tooltip-calculated">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Unlev IRR</p>
                    <p class="hero-metric-value" x-text="formatPercent(metrics.unleveraged_irr)">-</p>
                    <span class="tooltip-content"><strong>Unlevered IRR</strong> measures return on total investment (all-cash basis, no debt). Calculated using XIRR on property-level cash flows: initial cost, operating cash flows, and sale proceeds. Isolates property performance from financing.</span>
                </div>
                <div class="metric-card rounded-2xl p-5 hero-metric primary metric-tooltip tooltip-calculated">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Unlev Multiple</p>
                    <p class="hero-metric-value" x-text="formatMultiple(metrics.unleveraged_multiple)">-</p>
                    <span class="tooltip-content"><strong>Unlevered Multiple</strong> (MOIC) = Total distributions / Total cost. A 2.0x means you doubled your money. Doesn't account for timing - use with IRR for full picture. Good deals: <em>1.5-2.5x</em> over 5-10 years.</span>
                </div>
                <div class="metric-card rounded-2xl p-5 hero-metric success metric-tooltip tooltip-calculated">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Lev IRR</p>
                    <p class="hero-metric-value" x-text="formatPercent(metrics.leveraged_irr)">-</p>
                    <span class="tooltip-content"><strong>Leveraged IRR</strong> measures return on equity (after debt service). Higher than unlev IRR when returns exceed cost of debt. Shows impact of financial leverage on investor returns. Target: <em>15-25%</em> for value-add.</span>
                </div>
                <div class="metric-card rounded-2xl p-5 hero-metric success metric-tooltip tooltip-calculated">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Lev Multiple</p>
                    <p class="hero-metric-value" x-text="formatMultiple(metrics.leveraged_multiple)">-</p>
                    <span class="tooltip-content"><strong>Leveraged Multiple</strong> = Total equity distributions / Equity invested. Higher than unlev multiple due to debt magnification. Shows how much your equity grows. Typical targets: <em>1.8-2.5x</em>.</span>
                </div>
                <div class="metric-card rounded-2xl p-5 hero-metric accent metric-tooltip tooltip-calculated">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">LP IRR</p>
                    <p class="hero-metric-value" x-text="formatPercent(metrics.lp_irr)">-</p>
                    <span class="tooltip-content"><strong>LP IRR</strong> is the Limited Partner's return after waterfall splits. LP receives preferred return first, then shares remaining profits with GP. Lower than project IRR due to promote to GP.</span>
                </div>
                <div class="metric-card rounded-2xl p-5 hero-metric accent metric-tooltip tooltip-calculated">
                    <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">GP IRR</p>
                    <p class="hero-metric-value" x-text="formatPercent(metrics.gp_irr)">-</p>
                    <span class="tooltip-content"><strong>GP IRR</strong> is the General Partner/sponsor's return. Includes pro-rata equity returns plus promote (carried interest) above the preferred return hurdle. Higher than LP IRR due to performance incentive.</span>
                </div>
            </div>
        </div>

        <!-- No Metrics Calculated Message -->
        <div x-show="!metrics.unleveraged_irr && !metrics.leveraged_irr && !loading && scenario.id" class="mb-8">
            <div class="bg-amber-50 border border-amber-200 rounded-xl p-4">
                <div class="flex items-center gap-3">
                    <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                    <p class="text-amber-800">No return metrics calculated yet. Click <strong>Calculate</strong> to run the analysis.</p>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="bg-slate-100/80 rounded-t-2xl p-2 flex gap-1 overflow-x-auto">
            <template x-for="tab in tabs" :key="tab.id">
                <button @click="switchTab(tab.id)"
                        :class="activeTab === tab.id ? 'active' : ''"
                        class="tab-premium whitespace-nowrap">
                    <span x-text="tab.name"></span>
                </button>
            </template>
        </div>

        <!-- Tab Content Container -->
        <div class="bg-white rounded-b-3xl rounded-tr-3xl shadow-xl p-8">

            <!-- ============= ASSUMPTIONS TAB ============= -->
            <div x-show="activeTab === 'assumptions'" class="space-y-8">

                <div class="grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-8">

                    <!-- Property Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <div class="section-icon" style="background: var(--primary-gradient);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                            </div>
                            <h3 class="section-title">Property Details</h3>
                        </div>
                        <div class="space-y-5">
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Property Name
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content">A descriptive name for this property or asset. Use the property address or a memorable identifier. This name appears in all reports and dashboards.</span>
                                </label>
                                <input type="text" x-model="property.name" class="input-premium w-full" placeholder="Enter property name">
                            </div>
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Net Rentable Square Feet
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>Net Rentable SF (NRA)</strong> is the leasable area tenants pay rent on. It excludes common areas, mechanical rooms, and structural elements. Used to calculate <em>rent per SF</em> and <em>operating expenses per SF</em>.</span>
                                </label>
                                <div class="input-group">
                                    <input type="text"
                                        :value="formatNumber(assumptions.total_sf)"
                                        @focus="$el.value = assumptions.total_sf"
                                        @blur="assumptions.total_sf = parseFloat($el.value.replace(/,/g, '')) || 0; $el.value = formatNumber(assumptions.total_sf); scheduleCalculation()"
                                        class="input-premium w-full has-suffix">
                                    <span class="input-suffix">SF</span>
                                </div>
                            </div>
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Property Type
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content">The asset class of this property. Different property types have different <em>market dynamics</em>, <em>cap rate ranges</em>, and <em>tenant profiles</em>. This helps categorize your portfolio.</span>
                                </label>
                                <select x-model="property.property_type" class="input-premium w-full">
                                    <option value="retail">Retail</option>
                                    <option value="office">Office</option>
                                    <option value="multifamily">Multifamily</option>
                                    <option value="industrial">Industrial</option>
                                    <option value="mixed">Mixed Use</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Acquisition Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <div class="section-icon" style="background: var(--success-gradient);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <h3 class="section-title">Acquisition</h3>
                        </div>
                        <div class="space-y-5">
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Acquisition Date
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content">The <strong>closing date</strong> when ownership transfers. This is "Month 0" in your model - all cash flows and returns are calculated from this starting point.</span>
                                </label>
                                <input type="date" x-model="scenario.acquisition_date" @blur="scheduleCalculation()" class="input-premium w-full">
                            </div>
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Purchase Price
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content">The <strong>contract price</strong> for the property. Combined with closing costs, this determines your <em>total basis</em> and <em>going-in cap rate</em>. A lower price improves returns.</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-prefix">$</span>
                                    <input type="text"
                                        :value="formatDollars(scenario.purchase_price)"
                                        @focus="$el.value = scenario.purchase_price"
                                        @blur="scenario.purchase_price = parseFloat($el.value.replace(/,/g, '')) || 0; $el.value = formatDollars(scenario.purchase_price); scheduleCalculation()"
                                        class="input-premium w-full has-prefix">
                                </div>
                            </div>
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Closing Costs
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>Transaction costs</strong> at acquisition: title insurance, legal fees, due diligence, lender fees, etc. Typically <em>1-2% of purchase price</em>. Added to purchase price for total cost basis.</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-prefix">$</span>
                                    <input type="text"
                                        :value="formatDollars(scenario.closing_costs)"
                                        @focus="$el.value = scenario.closing_costs"
                                        @blur="scenario.closing_costs = parseFloat($el.value.replace(/,/g, '')) || 0; $el.value = formatDollars(scenario.closing_costs); scheduleCalculation()"
                                        class="input-premium w-full has-prefix">
                                </div>
                            </div>
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Hold Period
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>Investment timeline</strong> from acquisition to sale. Longer holds capture more rent growth but tie up capital. Typical CRE holds are <em>5-10 years</em> (60-120 months).</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" x-model.number="scenario.hold_period_months" @blur="scheduleCalculation()" class="input-premium w-full has-suffix">
                                    <span class="input-suffix">months</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Revenue Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <div class="section-icon" style="background: linear-gradient(135deg, #06b6d4 0%, #3b82f6 100%);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                            </div>
                            <h3 class="section-title">Revenue</h3>
                        </div>
                        <div class="space-y-5">
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Market Rent
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>Annual rent per SF</strong> achievable for new leases. This is multiplied by total SF to calculate <em>gross potential rent</em>. Research local comps to determine market rates for your property type.</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-prefix">$</span>
                                    <input type="number" x-model.number="assumptions.market_rent_psf" @blur="scheduleCalculation()" class="input-premium w-full has-prefix has-suffix">
                                    <span class="input-suffix">/SF/yr</span>
                                </div>
                            </div>
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Vacancy Rate
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>Expected unleased space</strong> as a percentage. Deducted from gross rent to get <em>effective gross revenue</em>. Includes turnover downtime. Stabilized retail: <em>3-5%</em>, office: <em>5-10%</em>.</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" x-model.number="assumptions.vacancy_rate" step="0.01" @blur="scheduleCalculation()" class="input-premium w-full has-suffix">
                                    <span class="input-suffix">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Annual Revenue Growth
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>Year-over-year rent increase</strong>. Applied annually to grow market rents. Reflects market dynamics and lease escalations. Conservative: <em>2-3%</em>, strong markets: <em>3-4%</em>.</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" x-model.number="assumptions.revenue_growth" step="0.001" @blur="scheduleCalculation()" class="input-premium w-full has-suffix">
                                    <span class="input-suffix">%/yr</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Expenses Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <div class="section-icon" style="background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z"/>
                                </svg>
                            </div>
                            <h3 class="section-title">Operating Expenses</h3>
                        </div>
                        <div class="space-y-5">
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Fixed Operating Expenses
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>Recurring operating costs</strong> per SF: insurance, utilities, maintenance, CAM. Deducted from revenue before calculating NOI. Varies by property type and location.</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-prefix">$</span>
                                    <input type="number" x-model.number="assumptions.fixed_opex_psf" @blur="scheduleCalculation()" class="input-premium w-full has-prefix has-suffix">
                                    <span class="input-suffix">/SF/yr</span>
                                </div>
                            </div>
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Management Fee
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>Property management cost</strong> as % of effective gross revenue. Covers leasing, tenant relations, accounting. Typical range: <em>2-4%</em> for commercial, <em>4-6%</em> for multifamily.</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" x-model.number="assumptions.management_fee_percent" step="0.01" @blur="scheduleCalculation()" class="input-premium w-full has-suffix">
                                    <span class="input-suffix">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Property Tax
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>Annual real estate taxes</strong> in full dollars. Usually reassessed at sale to higher purchase price. Check local mill rates - often <em>1-3% of assessed value</em> annually.</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-prefix">$</span>
                                    <input type="text"
                                        :value="formatDollars(assumptions.property_tax_amount)"
                                        @focus="$el.value = assumptions.property_tax_amount"
                                        @blur="assumptions.property_tax_amount = parseFloat($el.value.replace(/,/g, '')) || 0; $el.value = formatDollars(assumptions.property_tax_amount); scheduleCalculation()"
                                        class="input-premium w-full has-prefix has-suffix">
                                    <span class="input-suffix">/yr</span>
                                </div>
                            </div>
                            <div>
                                <label class="input-label tooltip-trigger">
                                    CapEx Reserve
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>Capital expenditure allowance</strong> for roof, HVAC, TI, etc. Set aside annually to fund major repairs. Typical: <em>$0.25-$1.00/SF/yr</em> depending on building age.</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-prefix">$</span>
                                    <input type="number" x-model.number="assumptions.capex_reserve_psf" @blur="scheduleCalculation()" class="input-premium w-full has-prefix has-suffix">
                                    <span class="input-suffix">/SF/yr</span>
                                </div>
                            </div>
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Expense Growth
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>Annual expense inflation</strong>. Operating costs typically rise with inflation. Conservative: <em>2-2.5%</em>. If expense growth exceeds rent growth, margins compress over time.</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" x-model.number="assumptions.expense_growth" step="0.001" @blur="scheduleCalculation()" class="input-premium w-full has-suffix">
                                    <span class="input-suffix">%/yr</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Exit Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <div class="section-icon" style="background: linear-gradient(135deg, #8b5cf6 0%, #ec4899 100%);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                                </svg>
                            </div>
                            <h3 class="section-title">Exit Strategy</h3>
                        </div>
                        <div class="space-y-5">
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Exit Cap Rate
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>Assumed cap rate at sale</strong>. Sale price = Forward NOI / Exit Cap. <em>Lower cap = higher value</em>. Typically model 25-50 bps higher than going-in cap (cap rate expansion) to be conservative.</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" x-model.number="scenario.exit_cap_rate" step="0.001" @blur="scheduleCalculation()" class="input-premium w-full has-suffix">
                                    <span class="input-suffix">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Sales Costs
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>Disposition costs</strong> as % of sale price: broker commissions, transfer taxes, legal fees. Typically <em>1.5-2.5%</em>. Deducted from gross sale proceeds to calculate net proceeds.</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" x-model.number="scenario.sales_cost_percent" step="0.001" @blur="scheduleCalculation()" class="input-premium w-full has-suffix">
                                    <span class="input-suffix">%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Waterfall Section -->
                    <div class="section-card">
                        <div class="section-header">
                            <div class="section-icon" style="background: var(--accent-gradient);">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                                </svg>
                            </div>
                            <h3 class="section-title">Partnership Structure</h3>
                        </div>
                        <div class="space-y-5">
                            <div>
                                <label class="input-label tooltip-trigger">
                                    LP Equity Share
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>Limited Partner equity contribution</strong> as % of total equity. LPs provide capital but don't manage the asset. Typical structures: <em>90% LP / 10% GP</em>. LP gets priority distributions up to the preferred return.</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" x-model.number="waterfall.lp_share" step="0.01" @blur="scheduleCalculation()" class="input-premium w-full has-suffix">
                                    <span class="input-suffix">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="input-label tooltip-trigger">
                                    GP Equity Share
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>General Partner (sponsor) equity</strong>. The GP manages the asset and typically invests <em>5-10%</em> of equity. GP earns promote/carried interest above the preferred return hurdle.</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" x-model.number="waterfall.gp_share" step="0.01" @blur="scheduleCalculation()" class="input-premium w-full has-suffix">
                                    <span class="input-suffix">%</span>
                                </div>
                            </div>
                            <div>
                                <label class="input-label tooltip-trigger">
                                    Preferred Return
                                    <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                    <span class="tooltip-content"><strong>LP priority return hurdle</strong>. LPs receive this return on their capital before GP earns promote. Market standard: <em>8-10%</em> annually. Compounded and accrued until paid.</span>
                                </label>
                                <div class="input-group">
                                    <input type="number" x-model.number="waterfall.pref_return" step="0.001" @blur="scheduleCalculation()" class="input-premium w-full has-suffix">
                                    <span class="input-suffix">%</span>
                                </div>
                            </div>
                            <!-- Multi-Hurdle Waterfall Toggle -->
                            <div class="pt-4 border-t border-slate-200">
                                <div class="flex items-center justify-between mb-3">
                                    <label class="input-label tooltip-trigger">
                                        Multi-Hurdle Promote
                                        <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                        <span class="tooltip-content"><strong>Multi-Hurdle Waterfall</strong>: Institutional-quality distribution structure with multiple return hurdles. GP earns increasing promote as each hurdle is cleared. Based on 225 Worth Ave Excel model structure.</span>
                                    </label>
                                    <button type="button"
                                        @click="waterfall.use_multi_hurdle = !waterfall.use_multi_hurdle"
                                        :class="waterfall.use_multi_hurdle ? 'bg-violet-600' : 'bg-slate-200'"
                                        class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors">
                                        <span :class="waterfall.use_multi_hurdle ? 'translate-x-6' : 'translate-x-1'"
                                            class="inline-block h-4 w-4 transform rounded-full bg-white transition-transform"></span>
                                    </button>
                                </div>
                                <!-- Hurdle Structure Display -->
                                <div x-show="waterfall.use_multi_hurdle" x-collapse class="mt-4 space-y-3">
                                    <div class="bg-gradient-to-r from-violet-50 to-purple-50 rounded-xl p-4 border border-violet-200">
                                        <p class="text-xs font-bold text-violet-800 uppercase tracking-wider mb-3">Waterfall Hurdle Structure</p>
                                        <div class="space-y-2 text-sm">
                                            <div class="flex justify-between items-center py-1.5 border-b border-violet-200">
                                                <span class="text-slate-600">Hurdle I (5% Pref)</span>
                                                <span class="font-medium text-slate-800">90% LP / 10% GP</span>
                                            </div>
                                            <div class="flex justify-between items-center py-1.5 border-b border-violet-200">
                                                <span class="text-slate-600">Hurdle II (5% Pref)</span>
                                                <span class="font-medium text-slate-800">75% LP / 8.33% GP + 16.67% Promote</span>
                                            </div>
                                            <div class="flex justify-between items-center py-1.5 border-b border-violet-200">
                                                <span class="text-slate-600">Hurdle III (5% Pref)</span>
                                                <span class="font-medium text-slate-800">75% LP / 8.33% GP + 16.67% Promote</span>
                                            </div>
                                            <div class="flex justify-between items-center py-1.5">
                                                <span class="text-slate-600 font-medium">Final Split</span>
                                                <span class="font-bold text-violet-700">75% LP / 25% GP (incl. promote)</span>
                                            </div>
                                        </div>
                                    </div>
                                    <p class="text-xs text-slate-500 italic">GP receives increasing promote at each hurdle, boosting GP IRR above LP IRR.</p>
                                </div>
                                <!-- Simple Structure Display -->
                                <div x-show="!waterfall.use_multi_hurdle" x-collapse class="mt-4">
                                    <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                                        <p class="text-xs font-bold text-slate-600 uppercase tracking-wider mb-2">Simple Waterfall</p>
                                        <p class="text-sm text-slate-600">Single hurdle with constant LP/GP split. No GP promote after pref.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ============= RENT ROLL TAB ============= -->
            <div x-show="activeTab === 'rentroll'" class="space-y-6">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-slate-900">Rent Roll</h2>
                        <p class="text-slate-500">Manage your tenant leases</p>
                    </div>
                    <button @click="addLease()" class="btn-primary-gradient flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Add Tenant
                    </button>
                </div>

                <!-- Summary Cards -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="metric-card rounded-2xl p-5 text-center metric-tooltip tooltip-calculated">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Total SF</p>
                        <p class="text-2xl font-bold text-slate-900" x-text="formatNumber(rentRollSummary.totalSF)">0</p>
                        <span class="tooltip-content"><strong>Total Square Feet</strong> across all leases in the rent roll. Sum of RSF for all tenant spaces. Compare to building NRA to identify vacant space.</span>
                    </div>
                    <div class="metric-card rounded-2xl p-5 text-center metric-tooltip tooltip-calculated">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Occupied SF</p>
                        <p class="text-2xl font-bold text-slate-900" x-text="formatNumber(rentRollSummary.occupiedSF)">0</p>
                        <span class="tooltip-content"><strong>Occupied Square Feet</strong> currently leased. Sum of RSF for all active leases. Difference from Total SF indicates vacancy.</span>
                    </div>
                    <div class="metric-card rounded-2xl p-5 text-center metric-tooltip tooltip-calculated">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Occupancy</p>
                        <p class="text-2xl font-bold text-emerald-600" x-text="formatPercent(rentRollSummary.occupancy)">0%</p>
                        <span class="tooltip-content"><strong>Physical Occupancy</strong> = Occupied SF / Total SF. Measures how much space is leased. Stabilized properties target <em>90-95%+</em>. Lower occupancy presents lease-up opportunity.</span>
                    </div>
                    <div class="metric-card rounded-2xl p-5 text-center metric-tooltip tooltip-calculated">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Avg Rent/SF</p>
                        <p class="text-2xl font-bold text-slate-900">$<span x-text="rentRollSummary.avgRentPSF.toFixed(2)">0</span></p>
                        <span class="tooltip-content"><strong>Average Rent per SF</strong> = Total annual rent / Total leased SF. Weighted average across all tenants. Compare to market rent to assess mark-to-market opportunity.</span>
                    </div>
                </div>

                <!-- Table -->
                <div class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Space</th>
                                <th>Tenant</th>
                                <th class="text-right">RSF</th>
                                <th class="text-right">Rent/SF</th>
                                <th class="text-right">Annual Rent</th>
                                <th class="text-center">Escalation</th>
                                <th class="text-center">Lease End</th>
                                <th class="text-center">Type</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="(lease, index) in leases" :key="lease.id || index">
                                <tr>
                                    <td>
                                        <input type="text" x-model="lease.space_id" class="input-premium w-16 text-center !py-2 !px-3">
                                    </td>
                                    <td>
                                        <input type="text" x-model="lease.tenant_name" class="input-premium w-40 !py-2 !px-3" placeholder="Tenant name">
                                    </td>
                                    <td class="text-right">
                                        <input type="number" x-model.number="lease.rsf" @blur="scheduleCalculation()" class="input-premium w-24 text-right !py-2 !px-3">
                                    </td>
                                    <td class="text-right">
                                        <input type="number" x-model.number="lease.base_rent_psf" step="0.01" @blur="scheduleCalculation()" class="input-premium w-24 text-right !py-2 !px-3">
                                    </td>
                                    <td class="text-right font-semibold text-slate-900">
                                        $<span x-text="formatNumber((lease.rsf || 0) * (lease.base_rent_psf || 0))">0</span>
                                    </td>
                                    <td class="text-center">
                                        <input type="number" x-model.number="lease.escalation_value" step="0.001" class="input-premium w-20 text-center !py-2 !px-3">
                                    </td>
                                    <td class="text-center">
                                        <input type="date" x-model="lease.lease_end" class="input-premium !py-2 !px-3">
                                    </td>
                                    <td class="text-center">
                                        <select x-model="lease.reimbursement_type" class="input-premium !py-2 !px-3">
                                            <option value="NNN">NNN</option>
                                            <option value="ModifiedGross">Mod Gross</option>
                                            <option value="FullService">Full Svc</option>
                                        </select>
                                    </td>
                                    <td>
                                        <button @click="removeLease(index)" class="text-red-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 transition">
                                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                            </svg>
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                    <div x-show="leases.length === 0" class="text-center py-16">
                        <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                            <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-slate-900 mb-2">No tenants yet</h3>
                        <p class="text-slate-500 mb-4">Get started by adding your first tenant lease</p>
                        <button @click="addLease()" class="btn-primary-gradient">Add First Tenant</button>
                    </div>
                </div>
            </div>

            <!-- ============= FINANCING TAB ============= -->
            <div x-show="activeTab === 'financing'" class="space-y-6">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-slate-900">Financing Structure</h2>
                        <p class="text-slate-500">Configure your capital stack</p>
                    </div>
                    <button @click="addLoan()" class="btn-primary-gradient flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"/>
                        </svg>
                        Add Loan
                    </button>
                </div>

                <!-- Capital Stack Summary -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
                    <div class="metric-card rounded-2xl p-5 text-center metric-tooltip tooltip-calculated">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Total Cost</p>
                        <p class="text-2xl font-bold text-slate-900">$<span x-text="formatDollars(financingSummary.totalCost)">0</span></p>
                        <span class="tooltip-content"><strong>Total Project Cost</strong> = Purchase price + closing costs + any CapEx. This is your total cost basis and denominator for LTC calculations.</span>
                    </div>
                    <div class="metric-card rounded-2xl p-5 text-center metric-tooltip tooltip-calculated">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Total Debt</p>
                        <p class="text-2xl font-bold text-amber-600">$<span x-text="formatDollars(financingSummary.totalDebt)">0</span></p>
                        <span class="tooltip-content"><strong>Total Debt</strong> across all loan tranches. Sum of senior, mezzanine, and any other debt. Higher debt = more leverage and higher equity returns (if profitable).</span>
                    </div>
                    <div class="metric-card rounded-2xl p-5 text-center metric-tooltip tooltip-calculated">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Total Equity</p>
                        <p class="text-2xl font-bold text-emerald-600">$<span x-text="formatDollars(financingSummary.totalEquity)">0</span></p>
                        <span class="tooltip-content"><strong>Total Equity</strong> = Total Cost - Total Debt. The cash investment required from LP and GP. This is the denominator for levered return calculations.</span>
                    </div>
                    <div class="metric-card rounded-2xl p-5 text-center metric-tooltip tooltip-calculated">
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">LTC Ratio</p>
                        <p class="text-2xl font-bold text-indigo-600" x-text="formatPercent(financingSummary.ltc)">0%</p>
                        <span class="tooltip-content"><strong>Loan-to-Cost Ratio</strong> = Total Debt / Total Cost. Measures leverage level. Conservative: <em>50-60%</em>. Aggressive: <em>70-80%</em>. Lenders cap based on DSCR and property type.</span>
                    </div>
                </div>

                <!-- Loan Cards -->
                <div class="space-y-4">
                    <template x-for="(loan, index) in loans" :key="loan.id || index">
                        <div class="section-card">
                            <div class="flex items-center justify-between mb-6">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center">
                                        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-slate-900" x-text="loan.name || 'Loan ' + (index + 1)"></h3>
                                        <span class="badge badge-success" x-text="loan.loan_type || 'acquisition'"></span>
                                    </div>
                                </div>
                                <button @click="removeLoan(index)" class="text-red-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 transition">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                    </svg>
                                </button>
                            </div>

                            <div class="grid grid-cols-2 md:grid-cols-4 gap-5">
                                <div>
                                    <label class="input-label tooltip-trigger">
                                        Loan Name
                                        <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                        <span class="tooltip-content"><strong>Identifier for this debt tranche</strong>. Use descriptive names like "Senior Debt", "Mezzanine", "Construction Loan" to distinguish multiple financing sources.</span>
                                    </label>
                                    <input type="text" x-model="loan.name" class="input-premium w-full" placeholder="Senior Debt">
                                </div>
                                <div>
                                    <label class="input-label tooltip-trigger">
                                        Loan Type
                                        <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                        <span class="tooltip-content"><strong>Loan purpose</strong>. <em>Acquisition</em>: purchase financing. <em>Permanent</em>: long-term hold. <em>Construction</em>: development draws. <em>Mezzanine</em>: subordinate debt behind senior.</span>
                                    </label>
                                    <select x-model="loan.loan_type" class="input-premium w-full">
                                        <option value="acquisition">Acquisition</option>
                                        <option value="permanent">Permanent</option>
                                        <option value="construction">Construction</option>
                                        <option value="mezzanine">Mezzanine</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="input-label tooltip-trigger">
                                        LTC Ratio
                                        <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                        <span class="tooltip-content"><strong>Loan-to-Cost ratio</strong>. Debt as % of total project cost. Auto-calculates loan amount. Senior debt typically <em>60-70%</em> LTC. Higher leverage increases returns but adds risk.</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" x-model.number="loan.ltc_ratio" step="0.01" @blur="scheduleCalculation()" class="input-premium w-full has-suffix">
                                        <span class="input-suffix">%</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="input-label tooltip-trigger">
                                        Loan Principal
                                        <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                        <span class="tooltip-content"><strong>Loan principal amount</strong> in full dollars. Enter directly or leave blank to auto-calculate from LTC ratio.</span>
                                    </label>
                                    <div class="input-group">
                                        <span class="input-prefix">$</span>
                                        <input type="text"
                                               :value="loan.amount ? loan.amount.toLocaleString() : ''"
                                               @input="loan.amount = parseFloat($event.target.value.replace(/,/g, '')) || null"
                                               @blur="$event.target.value = loan.amount ? loan.amount.toLocaleString() : ''"
                                               class="input-premium w-full has-prefix"
                                               :placeholder="loan.ltc_ratio ? 'Auto' : ''">
                                    </div>
                                </div>
                                <div>
                                    <label class="input-label tooltip-trigger">
                                        Interest Type
                                        <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                        <span class="tooltip-content"><strong>Rate structure</strong>. <em>Fixed</em>: locked rate for loan term. <em>Floating</em>: SOFR + spread, resets periodically. Floating has lower initial rate but interest rate risk.</span>
                                    </label>
                                    <select x-model="loan.interest_type" class="input-premium w-full">
                                        <option value="fixed">Fixed</option>
                                        <option value="floating">Floating</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="input-label tooltip-trigger" x-text="loan.interest_type === 'floating' ? 'Spread (bps)' : 'Interest Rate'">
                                        <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                        <span class="tooltip-content"><strong>Annual interest rate</strong> or spread over index. Used to calculate monthly debt service. Current senior rates: <em>5-7%</em>. Mezzanine: <em>10-14%</em>.</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" x-model.number="loan.fixed_rate" step="0.001" @blur="scheduleCalculation()" class="input-premium w-full has-suffix">
                                        <span class="input-suffix">%</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="input-label tooltip-trigger">
                                        I/O Period
                                        <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                        <span class="tooltip-content"><strong>Interest-only period</strong>. During I/O, pay only interest (no principal reduction). Improves early cash flow but leaves larger balance. Typical: <em>12-36 months</em>.</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" x-model.number="loan.io_months" @blur="scheduleCalculation()" class="input-premium w-full has-suffix">
                                        <span class="input-suffix">mo</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="input-label tooltip-trigger">
                                        Amortization
                                        <span class="tooltip-icon"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-.867.5 1 1 0 11-1.731-1A3 3 0 0113 8a3.001 3.001 0 01-2 2.83V11a1 1 0 11-2 0v-1a1 1 0 011-1 1 1 0 100-2zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd"/></svg></span>
                                        <span class="tooltip-content"><strong>Amortization schedule</strong>. Determines principal paydown rate after I/O period. Longer amortization = lower payments but slower equity build. Standard: <em>25-30 years</em>.</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="number" x-model.number="loan.amortization_years" @blur="scheduleCalculation()" class="input-premium w-full has-suffix">
                                        <span class="input-suffix">yrs</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <div x-show="loans.length === 0" class="text-center py-16">
                    <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-slate-900 mb-2">No financing configured</h3>
                    <p class="text-slate-500 mb-4">Add debt to see leveraged returns</p>
                    <button @click="addLoan()" class="btn-primary-gradient">Add First Loan</button>
                </div>
            </div>

            <!-- ============= CASH FLOWS TAB ============= -->
            <div x-show="activeTab === 'cashflows'" class="space-y-6">
                <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-slate-900">Cash Flow Projections</h2>
                        <p class="text-slate-500">View your projected returns over time</p>
                    </div>
                    <div class="flex bg-slate-100 rounded-xl p-1">
                        <button @click="cashflowView = 'annual'"
                                :class="cashflowView === 'annual' ? 'bg-white shadow-sm' : ''"
                                class="px-4 py-2 rounded-lg font-medium text-sm transition">Annual</button>
                        <button @click="cashflowView = 'monthly'"
                                :class="cashflowView === 'monthly' ? 'bg-white shadow-sm' : ''"
                                class="px-4 py-2 rounded-lg font-medium text-sm transition">Monthly</button>
                    </div>
                </div>

                <!-- Annual View -->
                <div x-show="cashflowView === 'annual'" class="bg-white rounded-2xl border border-slate-200 overflow-hidden">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Year</th>
                                <th class="text-right">Revenue</th>
                                <th class="text-right">Expenses</th>
                                <th class="text-right">NOI</th>
                                <th class="text-right">Debt Service</th>
                                <th class="text-right">Unlev CF</th>
                                <th class="text-right">Lev CF</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="cf in annualCashflows" :key="cf.year">
                                <tr>
                                    <td class="font-bold text-slate-900" x-text="'Year ' + cf.year"></td>
                                    <td class="text-right text-slate-600" x-text="'$' + formatDollars(cf.effective_revenue)"></td>
                                    <td class="text-right text-red-500" x-text="'($' + formatDollars(cf.total_expenses) + ')'"></td>
                                    <td class="text-right font-semibold text-slate-900" x-text="'$' + formatDollars(cf.noi)"></td>
                                    <td class="text-right text-red-500" x-text="'($' + formatDollars(cf.debt_service) + ')'"></td>
                                    <td class="text-right font-semibold" :class="cf.unleveraged_cash_flow >= 0 ? 'text-emerald-600' : 'text-red-600'"
                                        x-text="'$' + formatDollars(cf.unleveraged_cash_flow)"></td>
                                    <td class="text-right font-semibold" :class="cf.leveraged_cash_flow >= 0 ? 'text-emerald-600' : 'text-red-600'"
                                        x-text="'$' + formatDollars(cf.leveraged_cash_flow)"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <!-- Monthly View -->
                <div x-show="cashflowView === 'monthly'" class="bg-white rounded-2xl border border-slate-200 overflow-hidden max-h-[500px] overflow-y-auto">
                    <table class="data-table text-sm">
                        <thead class="sticky top-0 z-10">
                            <tr>
                                <th>Period</th>
                                <th>Date</th>
                                <th class="text-right">Revenue</th>
                                <th class="text-right">NOI</th>
                                <th class="text-right">Unlev CF</th>
                                <th class="text-right">Lev CF</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="cf in monthlyCashflows" :key="cf.period">
                                <tr>
                                    <td class="font-medium" x-text="cf.period"></td>
                                    <td class="text-slate-500" x-text="cf.date"></td>
                                    <td class="text-right" x-text="'$' + cf.effective_revenue.toFixed(0)"></td>
                                    <td class="text-right" x-text="'$' + cf.noi.toFixed(0)"></td>
                                    <td class="text-right" :class="cf.unleveraged_cash_flow >= 0 ? 'text-emerald-600' : 'text-red-600'"
                                        x-text="'$' + cf.unleveraged_cash_flow.toFixed(0)"></td>
                                    <td class="text-right" :class="cf.leveraged_cash_flow >= 0 ? 'text-emerald-600' : 'text-red-600'"
                                        x-text="'$' + cf.leveraged_cash_flow.toFixed(0)"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>

                <div x-show="annualCashflows.length === 0" class="text-center py-16">
                    <div class="w-16 h-16 bg-slate-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                        <svg class="w-8 h-8 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-slate-900 mb-2">No projections yet</h3>
                    <p class="text-slate-500 mb-4">Click Calculate to generate cash flow projections</p>
                    <button @click="calculateModel()" class="btn-primary-gradient">Calculate Now</button>
                </div>
            </div>

            <!-- ============= RETURNS TAB ============= -->
            <div x-show="activeTab === 'returns'" class="space-y-8">
                <div class="mb-6">
                    <h2 class="text-xl font-bold text-slate-900">Return Analysis</h2>
                    <p class="text-slate-500">Comprehensive view of investment performance</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Unleveraged -->
                    <div class="rounded-3xl p-8 bg-gradient-to-br from-indigo-500 to-purple-600 text-white">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">Unleveraged Returns</h3>
                                <p class="text-white/70 text-sm">All-cash basis</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-3 border-b border-white/20">
                                <span class="text-white/80">IRR</span>
                                <span class="text-3xl font-bold" x-text="formatPercent(metrics.unleveraged_irr)">-</span>
                            </div>
                            <div class="flex justify-between items-center py-3 border-b border-white/20">
                                <span class="text-white/80">Equity Multiple</span>
                                <span class="text-3xl font-bold" x-text="formatMultiple(metrics.unleveraged_multiple)">-</span>
                            </div>
                            <div class="flex justify-between items-center py-3">
                                <span class="text-white/80">Total Profit</span>
                                <span class="text-3xl font-bold">$<span x-text="formatDollars(metrics.unleveraged_profit)">-</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Leveraged -->
                    <div class="rounded-3xl p-8 bg-gradient-to-br from-emerald-500 to-teal-600 text-white">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">Leveraged Returns</h3>
                                <p class="text-white/70 text-sm">With debt financing</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-3 border-b border-white/20">
                                <span class="text-white/80">IRR</span>
                                <span class="text-3xl font-bold" x-text="formatPercent(metrics.leveraged_irr)">-</span>
                            </div>
                            <div class="flex justify-between items-center py-3 border-b border-white/20">
                                <span class="text-white/80">Equity Multiple</span>
                                <span class="text-3xl font-bold" x-text="formatMultiple(metrics.leveraged_multiple)">-</span>
                            </div>
                            <div class="flex justify-between items-center py-3">
                                <span class="text-white/80">Total Profit</span>
                                <span class="text-3xl font-bold">$<span x-text="formatDollars(metrics.leveraged_profit)">-</span></span>
                            </div>
                        </div>
                    </div>

                    <!-- LP Returns -->
                    <div class="rounded-3xl p-8 bg-gradient-to-br from-pink-500 to-rose-600 text-white">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">LP Returns</h3>
                                <p class="text-white/70 text-sm">Limited Partner</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-3 border-b border-white/20">
                                <span class="text-white/80">IRR</span>
                                <span class="text-3xl font-bold" x-text="formatPercent(metrics.lp_irr)">-</span>
                            </div>
                            <div class="flex justify-between items-center py-3">
                                <span class="text-white/80">Equity Share</span>
                                <span class="text-3xl font-bold" x-text="formatPercent(waterfall.lp_share)">90%</span>
                            </div>
                        </div>
                    </div>

                    <!-- GP Returns -->
                    <div class="rounded-3xl p-8 bg-gradient-to-br from-amber-500 to-orange-600 text-white">
                        <div class="flex items-center gap-3 mb-6">
                            <div class="w-12 h-12 bg-white/20 rounded-xl flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-bold">GP Returns</h3>
                                <p class="text-white/70 text-sm">General Partner / Sponsor</p>
                            </div>
                        </div>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-3 border-b border-white/20">
                                <span class="text-white/80">IRR</span>
                                <span class="text-3xl font-bold" x-text="formatPercent(metrics.gp_irr)">-</span>
                            </div>
                            <div class="flex justify-between items-center py-3">
                                <span class="text-white/80">Equity Share</span>
                                <span class="text-3xl font-bold" x-text="formatPercent(waterfall.gp_share)">10%</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Benchmark -->
                <div class="bg-slate-50 rounded-2xl p-6 border border-slate-200">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 bg-slate-200 rounded-xl flex items-center justify-center">
                            <svg class="w-5 h-5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <div>
                            <h4 class="font-bold text-slate-900">225 Worth Ave Benchmark</h4>
                            <p class="text-sm text-slate-500">Reference model targets</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-white rounded-xl p-4 text-center">
                            <p class="text-xs text-slate-500 uppercase font-medium mb-1">Unlev IRR</p>
                            <p class="text-lg font-bold text-slate-900">8.54%</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 text-center">
                            <p class="text-xs text-slate-500 uppercase font-medium mb-1">Lev IRR</p>
                            <p class="text-lg font-bold text-slate-900">11.43%</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 text-center">
                            <p class="text-xs text-slate-500 uppercase font-medium mb-1">LP IRR</p>
                            <p class="text-lg font-bold text-slate-900">10.59%</p>
                        </div>
                        <div class="bg-white rounded-xl p-4 text-center">
                            <p class="text-xs text-slate-500 uppercase font-medium mb-1">GP IRR</p>
                            <p class="text-lg font-bold text-slate-900">17.15%</p>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Deal Analysis Modal -->
    <div x-show="showAnalysisModal" x-cloak class="fixed inset-0 z-50 overflow-y-auto" @keydown.escape.window="showAnalysisModal = false">
        <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:p-0">
            <div class="fixed inset-0 bg-slate-900/50 transition-opacity" @click="showAnalysisModal = false"></div>

            <div class="relative bg-white rounded-2xl shadow-2xl max-w-4xl w-full mx-auto overflow-hidden transform transition-all">
                <!-- Modal Header -->
                <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between"
                     :class="dealAnalysis.hasCriticalIssues ? 'bg-red-50' : dealAnalysis.hasIssues ? 'bg-amber-50' : 'bg-emerald-50'">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center"
                             :class="dealAnalysis.hasCriticalIssues ? 'bg-red-100' : dealAnalysis.hasIssues ? 'bg-amber-100' : 'bg-emerald-100'">
                            <svg class="w-6 h-6" :class="dealAnalysis.hasCriticalIssues ? 'text-red-600' : dealAnalysis.hasIssues ? 'text-amber-600' : 'text-emerald-600'" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold" :class="dealAnalysis.hasCriticalIssues ? 'text-red-900' : dealAnalysis.hasIssues ? 'text-amber-900' : 'text-emerald-900'">Deal Analysis</h3>
                            <p class="text-sm" :class="dealAnalysis.hasCriticalIssues ? 'text-red-700' : dealAnalysis.hasIssues ? 'text-amber-700' : 'text-emerald-700'" x-text="dealAnalysis.hasCriticalIssues ? 'Critical issues require attention' : dealAnalysis.hasIssues ? 'Some items may need review' : 'Deal structure looks viable'"></p>
                        </div>
                    </div>
                    <button @click="showAnalysisModal = false" class="p-2 rounded-lg hover:bg-white/50 transition-colors">
                        <svg class="w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>

                <!-- Modal Body -->
                <div class="p-6 max-h-[70vh] overflow-y-auto">
                    <!-- Key Metrics Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-slate-50 rounded-xl p-4 text-center">
                            <p class="text-xs text-slate-500 uppercase font-medium mb-1">Monthly NOI</p>
                            <p class="text-xl font-bold text-slate-900">$<span x-text="Math.round(dealAnalysis.monthlyNOI).toLocaleString()"></span></p>
                        </div>
                        <div class="bg-slate-50 rounded-xl p-4 text-center">
                            <p class="text-xs text-slate-500 uppercase font-medium mb-1">Monthly Debt Service</p>
                            <p class="text-xl font-bold text-slate-900">$<span x-text="Math.round(dealAnalysis.monthlyDebtService).toLocaleString()"></span></p>
                        </div>
                        <div class="rounded-xl p-4 text-center" :class="dealAnalysis.dscr < 1 ? 'bg-red-50' : dealAnalysis.dscr < 1.25 ? 'bg-amber-50' : 'bg-emerald-50'">
                            <p class="text-xs uppercase font-medium mb-1" :class="dealAnalysis.dscr < 1 ? 'text-red-600' : dealAnalysis.dscr < 1.25 ? 'text-amber-600' : 'text-emerald-600'">DSCR</p>
                            <p class="text-xl font-bold" :class="dealAnalysis.dscr < 1 ? 'text-red-700' : dealAnalysis.dscr < 1.25 ? 'text-amber-700' : 'text-emerald-700'" x-text="dealAnalysis.dscr > 100 ? 'N/A' : dealAnalysis.dscr.toFixed(2) + 'x'"></p>
                        </div>
                        <div class="bg-slate-50 rounded-xl p-4 text-center">
                            <p class="text-xs text-slate-500 uppercase font-medium mb-1">LTC Ratio</p>
                            <p class="text-xl font-bold text-slate-900" x-text="(dealAnalysis.ltc * 100).toFixed(1) + '%'"></p>
                        </div>
                    </div>

                    <!-- Detailed Metrics Table -->
                    <div class="bg-slate-50 rounded-xl p-4 mb-6">
                        <h4 class="font-semibold text-slate-700 mb-3">Deal Economics</h4>
                        <div class="grid grid-cols-2 gap-x-8 gap-y-2 text-sm">
                            <div class="flex justify-between py-1 border-b border-slate-200">
                                <span class="text-slate-600">Annual NOI</span>
                                <span class="font-medium text-slate-900">$<span x-text="Math.round(dealAnalysis.annualNOI).toLocaleString()"></span></span>
                            </div>
                            <div class="flex justify-between py-1 border-b border-slate-200">
                                <span class="text-slate-600">Going-In Cap Rate</span>
                                <span class="font-medium text-slate-900" x-text="(dealAnalysis.goingInCap * 100).toFixed(2) + '%'"></span>
                            </div>
                            <div class="flex justify-between py-1 border-b border-slate-200">
                                <span class="text-slate-600">Total Debt</span>
                                <span class="font-medium text-slate-900">$<span x-text="Math.round(dealAnalysis.totalDebt).toLocaleString()"></span></span>
                            </div>
                            <div class="flex justify-between py-1 border-b border-slate-200">
                                <span class="text-slate-600">Exit Cap Rate</span>
                                <span class="font-medium text-slate-900" x-text="(dealAnalysis.exitCap * 100).toFixed(2) + '%'"></span>
                            </div>
                            <div class="flex justify-between py-1 border-b border-slate-200">
                                <span class="text-slate-600">Total Equity</span>
                                <span class="font-medium text-slate-900">$<span x-text="Math.round(dealAnalysis.totalEquity).toLocaleString()"></span></span>
                            </div>
                            <div class="flex justify-between py-1 border-b border-slate-200">
                                <span class="text-slate-600">Exit Value</span>
                                <span class="font-medium text-slate-900">$<span x-text="Math.round(dealAnalysis.netExitProceeds).toLocaleString()"></span></span>
                            </div>
                        </div>
                    </div>

                    <!-- Issues Section -->
                    <template x-if="dealAnalysis.hasIssues">
                        <div class="space-y-3">
                            <h4 class="font-semibold text-slate-700">Issues & Recommendations</h4>
                            <template x-for="issue in dealAnalysis.issues" :key="issue.title">
                                <div class="rounded-xl p-4 border"
                                     :class="issue.severity === 'critical' ? 'bg-red-50 border-red-200' : issue.severity === 'warning' ? 'bg-amber-50 border-amber-200' : 'bg-blue-50 border-blue-200'">
                                    <div class="flex items-start gap-3">
                                        <div class="flex-shrink-0 mt-0.5">
                                            <svg x-show="issue.severity === 'critical'" class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                            </svg>
                                            <svg x-show="issue.severity === 'warning'" class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                            <svg x-show="issue.severity === 'info'" class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                            </svg>
                                        </div>
                                        <div class="flex-1">
                                            <p class="font-semibold" :class="issue.severity === 'critical' ? 'text-red-800' : issue.severity === 'warning' ? 'text-amber-800' : 'text-blue-800'" x-text="issue.title"></p>
                                            <p class="text-sm mt-1" :class="issue.severity === 'critical' ? 'text-red-700' : issue.severity === 'warning' ? 'text-amber-700' : 'text-blue-700'" x-text="issue.description"></p>
                                            <p class="text-sm mt-2 font-medium" :class="issue.severity === 'critical' ? 'text-red-800' : issue.severity === 'warning' ? 'text-amber-800' : 'text-blue-800'">
                                                <span class="opacity-75">Suggestion:</span> <span x-text="issue.suggestion"></span>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </template>

                    <!-- No Issues Message -->
                    <template x-if="!dealAnalysis.hasIssues">
                        <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-4">
                            <div class="flex items-center gap-3">
                                <svg class="w-6 h-6 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                <div>
                                    <p class="font-semibold text-emerald-800">Deal Structure Looks Good</p>
                                    <p class="text-sm text-emerald-700">No critical issues detected. DSCR and exit assumptions appear reasonable.</p>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Note about calculation errors -->
                    <template x-if="metrics._errors && metrics._errors.length > 0">
                        <div class="mt-4 bg-slate-100 rounded-xl p-4">
                            <p class="text-sm text-slate-600">
                                <span class="font-medium">Note:</span> The calculation errors above (e.g., "Cash flows must contain both positive and negative values")
                                typically occur when leveraged cash flows are all negative - meaning debt service exceeds income every period
                                and the exit value doesn't cover the loan payoff. Fix the issues above to resolve these errors.
                            </p>
                        </div>
                    </template>
                </div>

                <!-- Modal Footer -->
                <div class="px-6 py-4 border-t border-slate-200 bg-slate-50 flex justify-end">
                    <button @click="showAnalysisModal = false" class="px-4 py-2 bg-slate-900 text-white rounded-xl font-medium hover:bg-slate-800 transition-colors">
                        Close
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function modelEditor() {
    return {
        activeTab: localStorage.getItem('modelEditorTab') || 'assumptions',
        loading: false,
        cashflowView: 'annual',
        error: null,
        successMessage: null,
        showPropertyModal: false,
        showAnalysisModal: false,

        tabs: [
            { id: 'assumptions', name: 'Assumptions' },
            { id: 'rentroll', name: 'Rent Roll' },
            { id: 'financing', name: 'Financing' },
            { id: 'cashflows', name: 'Cash Flows' },
            { id: 'returns', name: 'Returns' },
        ],

        newProperty: {
            name: '',
            property_type: 'retail',
            address_city: '',
            address_state: '',
            net_rentable_sf: 10000,
        },

        property: { id: null, name: '', property_type: 'retail', address_city: '', address_state: '' },

        scenario: {
            id: null, name: 'Base Case',
            acquisition_date: new Date().toISOString().split('T')[0],
            hold_period_months: 120, purchase_price: 0, closing_costs: 0,
            exit_cap_rate: 0.05, sales_cost_percent: 0.01,
        },

        assumptions: {
            total_sf: 10000, market_rent_psf: 300, in_place_rent_psf: 200,
            vacancy_rate: 0, fixed_opex_psf: 36, management_fee_percent: 0.04,
            property_tax_amount: 0, capex_reserve_psf: 5,
            revenue_growth: 0.025, expense_growth: 0.025,
        },

        waterfall: {
            lp_share: 0.90, gp_share: 0.10, pref_return: 0.05, compound_monthly: false,
            use_multi_hurdle: true,
            final_lp_split: 0.75, final_gp_split: 0.0833, final_gp_promote: 0.1667,
        },

        leases: [], loans: [], deletedLeases: [], deletedLoans: [],
        metrics: {}, annualCashflows: [], monthlyCashflows: [],
        calcTimeout: null,

        get rentRollSummary() {
            const totalSF = this.leases.reduce((sum, l) => sum + (l.rsf || 0), 0);
            const occupiedSF = this.leases.filter(l => !l.is_vacant).reduce((sum, l) => sum + (l.rsf || 0), 0);
            const totalRent = this.leases.reduce((sum, l) => sum + ((l.rsf || 0) * (l.base_rent_psf || 0)), 0);
            return { totalSF, occupiedSF, occupancy: totalSF > 0 ? occupiedSF / totalSF : 0, avgRentPSF: occupiedSF > 0 ? totalRent / occupiedSF : 0 };
        },

        get financingSummary() {
            const totalCost = (this.scenario.purchase_price || 0) + (this.scenario.closing_costs || 0);
            let totalDebt = 0;
            for (const loan of this.loans) { totalDebt += loan.amount || (loan.ltc_ratio ? totalCost * loan.ltc_ratio : 0); }
            return { totalCost, totalDebt, totalEquity: totalCost - totalDebt, ltc: totalCost > 0 ? totalDebt / totalCost : 0 };
        },

        get dealAnalysis() {
            // Calculate key deal metrics for analysis
            const totalCost = (this.scenario.purchase_price || 0) + (this.scenario.closing_costs || 0);
            const totalSF = this.leases.reduce((sum, l) => sum + (l.rsf || 0), 0) || this.assumptions.total_sf || 10000;
            const vacancy = this.assumptions.vacancy_rate || 0;

            // Calculate annual rent from leases or assumptions
            let annualRent = 0;
            if (this.leases.length > 0) {
                annualRent = this.leases.reduce((sum, l) => sum + ((l.rsf || 0) * (l.base_rent_psf || 0)), 0);
            } else {
                annualRent = totalSF * (this.assumptions.in_place_rent_psf || 200);
            }
            const effectiveRent = annualRent * (1 - vacancy);

            // Calculate expenses
            const fixedOpex = totalSF * (this.assumptions.fixed_opex_psf || 36);
            const mgmtFee = effectiveRent * (this.assumptions.management_fee_percent || 0.04);
            const propTax = this.assumptions.property_tax_amount || 0;
            const capex = totalSF * (this.assumptions.capex_reserve_psf || 5);
            const totalOpex = fixedOpex + mgmtFee + propTax + capex;

            // Calculate NOI
            const annualNOI = effectiveRent - totalOpex;
            const monthlyNOI = annualNOI / 12;

            // Calculate debt metrics
            let totalDebt = 0;
            let interestRate = 0.05;
            for (const loan of this.loans) {
                const loanAmt = loan.amount || (loan.ltc_ratio ? totalCost * loan.ltc_ratio : 0);
                totalDebt += loanAmt;
                if (loanAmt > 0) interestRate = loan.fixed_rate || 0.05;
            }
            const monthlyDebtService = totalDebt * interestRate / 12;
            const totalEquity = totalCost - totalDebt;
            const ltc = totalCost > 0 ? totalDebt / totalCost : 0;

            // Calculate DSCR
            const dscr = monthlyDebtService > 0 ? monthlyNOI / monthlyDebtService : 999;

            // Calculate going-in cap rate
            const goingInCap = totalCost > 0 ? annualNOI / totalCost : 0;

            // Calculate exit value
            const exitCap = this.scenario.exit_cap_rate || 0.05;
            const holdMonths = this.scenario.hold_period_months || 120;
            const rentGrowth = this.assumptions.revenue_growth || 0.025;
            const years = holdMonths / 12;
            const exitNOI = annualNOI * Math.pow(1 + rentGrowth, years);
            const exitValue = exitCap > 0 ? exitNOI / exitCap : 0;
            const salesCost = exitValue * (this.scenario.sales_cost_percent || 0.01);
            const netExitProceeds = exitValue - salesCost;

            // Check issues
            const issues = [];
            if (dscr < 1.0 && totalDebt > 0) {
                issues.push({
                    severity: 'critical',
                    title: 'Negative Cash Flow',
                    description: `DSCR of ${dscr.toFixed(2)}x means debt service exceeds NOI. The property cannot support this debt level.`,
                    suggestion: `Reduce loan to ~$${Math.round(monthlyNOI / (interestRate/12) * 0.8 / 1000)}K for 1.25x DSCR`
                });
            } else if (dscr < 1.25 && totalDebt > 0) {
                issues.push({
                    severity: 'warning',
                    title: 'Low Debt Coverage',
                    description: `DSCR of ${dscr.toFixed(2)}x is below typical 1.25x lender requirement.`,
                    suggestion: 'Consider reducing leverage or improving NOI'
                });
            }

            if (netExitProceeds < totalDebt && totalDebt > 0) {
                issues.push({
                    severity: 'critical',
                    title: 'Underwater at Exit',
                    description: `Exit value ($${(netExitProceeds/1000000).toFixed(1)}M) is less than loan payoff ($${(totalDebt/1000000).toFixed(1)}M).`,
                    suggestion: `Lower exit cap rate or reduce loan amount`
                });
            }

            if (goingInCap < 0.03) {
                issues.push({
                    severity: 'warning',
                    title: 'Very Low Cap Rate',
                    description: `Going-in cap of ${(goingInCap*100).toFixed(2)}% indicates premium pricing.`,
                    suggestion: 'Ensure exit assumptions support value preservation'
                });
            }

            if (goingInCap < exitCap && goingInCap > 0) {
                issues.push({
                    severity: 'info',
                    title: 'Cap Rate Expansion',
                    description: `Buying at ${(goingInCap*100).toFixed(2)}% cap, selling at ${(exitCap*100).toFixed(1)}% cap implies value decline.`,
                    suggestion: 'Consider lower exit cap rate or factor in renovation/value-add'
                });
            }

            return {
                annualRent, effectiveRent, totalOpex, annualNOI, monthlyNOI,
                totalDebt, monthlyDebtService, totalEquity, ltc, dscr,
                goingInCap, exitCap, exitNOI, exitValue, netExitProceeds,
                issues, hasIssues: issues.length > 0,
                hasCriticalIssues: issues.some(i => i.severity === 'critical')
            };
        },

        async init() {
            const modelId = '{{ model_id }}';
            const propertyId = '{{ property_id }}';
            if (modelId && modelId !== 'new') { await this.loadScenario(modelId); }
            else if (propertyId) { await this.loadProperty(propertyId); this.scenario.id = null; this.scenario.name = 'New Scenario'; }
            else { this.showPropertyModal = true; }
        },

        async loadProperty(propertyId) {
            try {
                const response = await fetch(`/api/properties/${propertyId}`);
                if (!response.ok) throw new Error('Property not found');
                const data = await response.json();
                this.property = { id: data.id, name: data.name || '', property_type: data.property_type || 'retail', address_city: data.address_city || '', address_state: data.address_state || '' };
                if (data.net_rentable_sf) this.assumptions.total_sf = data.net_rentable_sf;
            } catch (error) { this.error = 'Failed to load property: ' + error.message; }
        },

        async loadScenario(id) {
            this.loading = true;
            try {
                const response = await fetch(`/api/scenarios/${id}`);
                if (!response.ok) throw new Error('Scenario not found');
                const data = await response.json();
                this.scenario = { id: data.id, name: data.name || 'Unnamed Scenario', acquisition_date: data.acquisition_date, hold_period_months: data.hold_period_months || 120, purchase_price: data.purchase_price || 0, closing_costs: data.closing_costs || 0, exit_cap_rate: data.exit_cap_rate || 0.05, sales_cost_percent: data.sales_cost_percent || 0.01 };
                if (data.operating_assumptions) this.assumptions = { ...this.assumptions, ...data.operating_assumptions };
                if (data.waterfall_structure) this.waterfall = { ...this.waterfall, ...data.waterfall_structure };
                if (data.leases) this.leases = data.leases.map(l => ({ ...l, _persisted: true }));
                if (data.loans) this.loans = data.loans.map(ln => ({ ...ln, _persisted: true }));
                if (data.return_metrics) this.metrics = data.return_metrics;
                if (data.property_id) await this.loadProperty(data.property_id);
                // Always recalculate to ensure fresh metrics
                await this.calculateModel();
            } catch (error) { this.error = 'Failed to load scenario: ' + error.message; }
            finally { this.loading = false; }
        },

        async createProperty() {
            this.loading = true;
            try {
                const response = await fetch('/api/properties', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.newProperty) });
                if (!response.ok) throw new Error('Failed to create property');
                const created = await response.json();
                this.property = { id: created.id, name: created.name, property_type: created.property_type || 'retail', address_city: created.address_city || '', address_state: created.address_state || '' };
                this.assumptions.total_sf = created.net_rentable_sf || 10000;
                this.showPropertyModal = false;
                this.successMessage = 'Property created!'; setTimeout(() => this.successMessage = null, 3000);
            } catch (error) { this.error = error.message; }
            finally { this.loading = false; }
        },

        async calculateModel() {
            this.loading = true; this.error = null;
            try {
                if (this.scenario.id) {
                    const calcResponse = await fetch(`/api/scenarios/${this.scenario.id}/calculate`, { method: 'POST' });
                    if (calcResponse.ok) { const calcData = await calcResponse.json(); this.metrics = calcData.metrics || {}; }
                    const monthlyResponse = await fetch(`/api/scenarios/${this.scenario.id}/cashflows?period_type=monthly`);
                    if (monthlyResponse.ok) { const data = await monthlyResponse.json(); this.monthlyCashflows = data.cashflows || []; }
                    const annualResponse = await fetch(`/api/scenarios/${this.scenario.id}/cashflows?period_type=annual`);
                    if (annualResponse.ok) { const data = await annualResponse.json(); this.annualCashflows = data.cashflows || []; }
                } else { await this.calculateModelDirect(); }
                this.successMessage = 'Calculation complete!'; setTimeout(() => this.successMessage = null, 3000);
            } catch (error) { this.error = 'Error calculating: ' + error.message; }
            finally { this.loading = false; }
        },

        async calculateModelDirect() {
            let inPlaceRent = this.assumptions.in_place_rent_psf;
            const totalSF = this.leases.reduce((sum, l) => sum + (l.rsf || 0), 0);
            if (totalSF > 0) inPlaceRent = this.leases.reduce((sum, l) => sum + ((l.rsf || 0) * (l.base_rent_psf || 0)), 0) / totalSF;
            let loanAmount = 0;
            const totalCost = (this.scenario.purchase_price || 0) + (this.scenario.closing_costs || 0);
            if (this.loans.length > 0) { const loan = this.loans[0]; loanAmount = loan.amount || (loan.ltc_ratio ? totalCost * loan.ltc_ratio : 0); }

            // Build tenants array for tenant-by-tenant calculation
            const acquisitionDate = new Date(this.scenario.acquisition_date);
            const tenants = this.leases.filter(l => l.rsf > 0 && !l.is_vacant).map(l => {
                // Calculate lease_end_month as months from acquisition date
                let leaseEndMonth = 120; // Default to hold period if no end date
                if (l.lease_end) {
                    const leaseEnd = new Date(l.lease_end);
                    const monthsDiff = (leaseEnd.getFullYear() - acquisitionDate.getFullYear()) * 12
                        + (leaseEnd.getMonth() - acquisitionDate.getMonth());
                    leaseEndMonth = Math.max(0, monthsDiff);
                }
                return {
                    name: l.tenant_name || 'Tenant',
                    rsf: l.rsf || 0,
                    in_place_rent_psf: l.base_rent_psf || 0,
                    market_rent_psf: this.assumptions.market_rent_psf || 300,
                    lease_end_month: leaseEndMonth
                };
            });

            // Convert monetary values from full dollars to $000s for API
            const toThousands = (val) => (val || 0) / 1000;

            const response = await fetch('/api/calculate/cashflows', {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    acquisition_date: this.scenario.acquisition_date, hold_period_months: this.scenario.hold_period_months,
                    purchase_price: toThousands(this.scenario.purchase_price), closing_costs: toThousands(this.scenario.closing_costs),
                    total_sf: totalSF || this.assumptions.total_sf, in_place_rent_psf: inPlaceRent,
                    market_rent_psf: this.assumptions.market_rent_psf, rent_growth: this.assumptions.revenue_growth,
                    vacancy_rate: this.assumptions.vacancy_rate, fixed_opex_psf: this.assumptions.fixed_opex_psf,
                    management_fee_percent: this.assumptions.management_fee_percent, property_tax_amount: toThousands(this.assumptions.property_tax_amount),
                    capex_reserve_psf: this.assumptions.capex_reserve_psf, expense_growth: this.assumptions.expense_growth,
                    exit_cap_rate: this.scenario.exit_cap_rate, sales_cost_percent: this.scenario.sales_cost_percent,
                    loan_amount: toThousands(loanAmount), interest_rate: this.loans[0]?.fixed_rate || 0.05,
                    io_months: this.loans[0]?.io_months || 120, amortization_years: this.loans[0]?.amortization_years || 30,
                    tenants: tenants.length > 0 ? tenants : null,
                    lp_share: this.waterfall.lp_share, gp_share: this.waterfall.gp_share, pref_return: this.waterfall.pref_return,
                    compound_monthly: this.waterfall.compound_monthly || false,
                    use_multi_hurdle: this.waterfall.use_multi_hurdle !== false,
                    final_lp_split: this.waterfall.final_lp_split || 0.75,
                    final_gp_split: this.waterfall.final_gp_split || 0.0833,
                    final_gp_promote: this.waterfall.final_gp_promote || 0.1667,
                })
            });
            if (!response.ok) throw new Error('Calculation failed');
            const data = await response.json();
            this.metrics = data.metrics;
            this.annualCashflows = data.annual_cashflows || [];
            this.monthlyCashflows = data.monthly_cashflows || [];
        },

        scheduleCalculation() {
            // Debounce auto-calculation to avoid excessive API calls
            if (this.calcTimeout) clearTimeout(this.calcTimeout);
            this.calcTimeout = setTimeout(() => {
                this.calculateModelDirect().catch(err => {
                    console.error('Auto-calculate error:', err);
                });
            }, 500);
        },

        async saveScenario() {
            if (!this.property.id) { this.error = 'Please create a property first'; return; }
            this.loading = true; this.error = null;
            try {
                const payload = {
                    property_id: this.property.id, name: this.scenario.name, is_base_case: false,
                    acquisition_date: this.scenario.acquisition_date, hold_period_months: this.scenario.hold_period_months || 120,
                    purchase_price: this.scenario.purchase_price || 0, closing_costs: this.scenario.closing_costs || 0,
                    exit_cap_rate: this.scenario.exit_cap_rate || 0.05, sales_cost_percent: this.scenario.sales_cost_percent || 0.01,
                    market_rent_psf: this.assumptions.market_rent_psf || 300, vacancy_rate: this.assumptions.vacancy_rate || 0, collection_loss: 0,
                    fixed_opex_psf: this.assumptions.fixed_opex_psf || 36, variable_opex_psf: 0,
                    management_fee_percent: this.assumptions.management_fee_percent || 0.04,
                    property_tax_amount: this.assumptions.property_tax_amount || 0, property_tax_millage: 0.015,
                    capex_reserve_psf: this.assumptions.capex_reserve_psf || 5, revenue_growth: this.assumptions.revenue_growth || 0.025,
                    expense_growth: this.assumptions.expense_growth || 0.025, lp_share: this.waterfall.lp_share || 0.90,
                    gp_share: this.waterfall.gp_share || 0.10, pref_return: this.waterfall.pref_return || 0.05, compound_monthly: false,
                    leases: this.leases.map(l => ({ tenant_name: l.tenant_name || 'Vacant', space_id: l.space_id || 'A', rsf: l.rsf || 0, base_rent_psf: l.base_rent_psf || 0, market_rent_psf: this.assumptions.market_rent_psf || 300, escalation_type: 'percentage', escalation_value: l.escalation_value || 0.025, escalation_frequency: 'annual', lease_start: l.lease_start || this.scenario.acquisition_date, lease_end: l.lease_end || this.scenario.acquisition_date, free_rent_months: 0, ti_allowance_psf: 0, reimbursement_type: l.reimbursement_type || 'NNN', recovery_percentage: 1.0, is_vacant: l.is_vacant || false })),
                    loans: this.loans.map(ln => ({ name: ln.name || 'Loan', loan_type: ln.loan_type || 'acquisition', amount: ln.amount || null, ltc_ratio: ln.ltc_ratio || null, interest_type: ln.interest_type || 'fixed', fixed_rate: ln.fixed_rate || 0.05, io_months: ln.io_months || 120, amortization_years: ln.amortization_years || 30, maturity_months: 120 })),
                };
                let response;
                if (this.scenario.id) { response = await fetch(`/api/scenarios/${this.scenario.id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); }
                else { response = await fetch('/api/scenarios', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); }
                if (!response.ok) throw new Error('Save failed');
                const saved = await response.json();
                this.scenario.id = saved.id;
                if (saved.leases) this.leases = saved.leases.map(l => ({ ...l, _persisted: true }));
                if (saved.loans) this.loans = saved.loans.map(ln => ({ ...ln, _persisted: true }));
                if (saved.return_metrics) this.metrics = saved.return_metrics;
                if (window.history.replaceState) window.history.replaceState({}, '', `/model/${saved.id}`);
                this.successMessage = 'Saved!'; setTimeout(() => this.successMessage = null, 3000);
            } catch (error) { this.error = error.message; }
            finally { this.loading = false; }
        },

        switchTab(tabId) {
            this.activeTab = tabId;
            localStorage.setItem('modelEditorTab', tabId);
            // Auto-calculate when switching to returns or cashflows tabs if no data yet
            if ((tabId === 'returns' || tabId === 'cashflows') &&
                Object.keys(this.metrics).length === 0 &&
                this.scenario.purchase_price > 0) {
                this.calculateModel();
            }
        },

        addLease() { this.leases.push({ id: 'temp_' + Date.now(), space_id: String.fromCharCode(65 + this.leases.length), tenant_name: '', rsf: 0, base_rent_psf: this.assumptions.market_rent_psf, escalation_value: 0.025, lease_start: this.scenario.acquisition_date, lease_end: '', reimbursement_type: 'NNN', _persisted: false }); },
        removeLease(index) { const lease = this.leases[index]; if (lease._persisted && lease.id && !lease.id.startsWith('temp_')) this.deletedLeases.push(lease.id); this.leases.splice(index, 1); },
        addLoan() { this.loans.push({ id: 'temp_' + Date.now(), name: `Loan ${this.loans.length + 1}`, loan_type: 'acquisition', ltc_ratio: null, amount: null, interest_type: 'fixed', fixed_rate: 0.05, io_months: 120, amortization_years: 30, _persisted: false }); },
        removeLoan(index) { const loan = this.loans[index]; if (loan._persisted && loan.id && !loan.id.startsWith('temp_')) this.deletedLoans.push(loan.id); this.loans.splice(index, 1); },

        formatPercent(value) { return value == null ? '-' : (value * 100).toFixed(2) + '%'; },
        formatMultiple(value) { return value == null ? '-' : value.toFixed(2) + 'x'; },
        formatNumber(value) { return value == null ? '0' : Math.round(value).toLocaleString(); },
        formatDollars(value) { return value == null ? '0' : Math.round(value).toLocaleString('en-US'); },
    };
}
</script>
{% endblock %}
